"use strict";function _createForOfIteratorHelper(e,i){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=_unsupportedIterableToArray(e))||i&&e&&"number"==typeof e.length){n&&(e=n);var t=0,o=function(){};return{s:o,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,c=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return c=e.done,e},e:function(e){a=!0,r=e},f:function(){try{c||null==n.return||n.return()}finally{if(a)throw r}}}}function _unsupportedIterableToArray(e,i){if(e){if("string"==typeof e)return _arrayLikeToArray(e,i);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,i):void 0}}function _arrayLikeToArray(e,i){(null==i||i>e.length)&&(i=e.length);for(var n=0,t=new Array(i);n<i;n++)t[n]=e[n];return t}!function(e,i,n,t){if(void 0!==i&&void 0!==n&&void 0!==t){var o=t.i18n.__,r=t.i18n.sprintf,c={modal:null,loader:null,markers:[],map:null,listingContainer:null,infoWindowOpened:null,isInitialized:!1};i(function(){i(document.body).on("updated_shipping_method",function(){return f()}).on("updated_wc_div",function(){return f()}).on("updated_checkout",function(){return f()}),f()}),e.set_wms_google_maps_pickup_modal=f}else console.error("WMS Google Maps: Missing dependencies");function a(e){if(c.listingContainer){var i='\n      <div class="wms-error-message">\n        <strong>'.concat(o("Erreur","wc-multishipping"),"</strong>\n        <p>").concat(e,"</p>\n      </div>\n    ");c.listingContainer.innerHTML=i}}function d(){c.loader&&(c.loader.style.display="none")}function l(){document.querySelectorAll(".wms_pickup_modal_listing_one").forEach(function(e){return e.classList.remove("wms_is_selected")})}function s(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;e||(e=document.querySelectorAll(".wms_pickup_modal_listing_one_button_ship")),e.forEach(function(e){e.addEventListener("click",function(e){var n,t,d,l;e.stopPropagation();var s=this.closest(".wms_pickup_modal_listing_one");if(s){var u={id:this.getAttribute("data-pickup-id"),name:s.getAttribute("data-pickup-name"),address:null===(n=s.querySelector(".wms_pickup_address1"))||void 0===n?void 0:n.getAttribute("data-pickup-address1"),zipcode:null===(t=s.querySelector(".wms_pickup_zipcode"))||void 0===t?void 0:t.getAttribute("data-pickup-zipcode"),city:null===(d=s.querySelector(".wms_pickup_city"))||void 0===d?void 0:d.getAttribute("data-pickup-city"),country:null===(l=s.querySelector(".wms_pickup_country"))||void 0===l?void 0:l.getAttribute("data-pickup-country")},p=[u.name,u.address,"".concat(u.city," ").concat(u.zipcode),u.country];if(confirm(r(o("Merci de confirmer votre choix: %s","wc-multishipping"),"\n\n"+p.join("\n")))){var m=document.getElementById("wms_pickup_point");m&&(m.value=u.id,m.dispatchEvent(new Event("change")));var _=i("#wms_shipping_provider").val(),v=i("#wms_nonce").val();i.ajax({url:WMS.ajaxurl,type:"POST",dataType:"json",data:{action:"wms_select_pickup_point",pickup_id:u.id,pickup_name:u.name,pickup_address:u.address,pickup_zipcode:u.zipcode,pickup_city:u.city,pickup_country:u.country,pickup_provider:_,wms_nonce:v},beforeSend:function(){i("#wms_ajax_error").hide()},success:function(e){if(!1===e.error){var n;if(i("#wms_pickup_selected").html("<div>"+p.join("</div><div>")+"</div>"),i(".wc-block-components-shipping-address").each(function(){-1!==i(this).html().indexOf("Livraison à")&&i(this).html("Livraison à : "+p.join("\n"))}),c.modal)null===(n=c.modal.querySelector(".modal-close"))||void 0===n||n.click();i("body").trigger("update_checkout")}else{var t=i("#wms_ajax_error");t.html(e.error_message),t.show()}},error:function(){a(o("Une erreur est survenue lors de la sélection du point relais","wc-multishipping"))}})}}})})}function u(e,i,n){console.error("WMS Google Maps AJAX Error:",n),a(o("Une erreur est survenue lors de la récupération des points relais","wc-multishipping"))}function p(e){if(e.error)a(e.error_message);else if(e.data&&0!==e.data.length){var i=new n.maps.LatLngBounds;c.listingContainer.innerHTML="",e.data.forEach(function(e){var t={lat:parseFloat(e.latitude),lng:parseFloat(e.longitude)},r=new n.maps.Marker({position:t,map:c.map,title:e.name,visible:!0,icon:"https://maps.google.com/mapfiles/ms/icons/red-dot.png"});!function(e,i){e.addListener("click",function(){c.infoWindowOpened&&c.infoWindowOpened.close(),i.open(c.map,e),c.infoWindowOpened=i,l(),n.maps.event.addListener(i,"domready",function(){var e=document.querySelectorAll(".wms_pickup_modal_infowindow_one_button_ship");e.length>0&&s(e)});var t=document.querySelector('[data-pickup-name="'.concat(e.getTitle(),'"]'));t&&(t.scrollIntoView({behavior:"smooth",block:"nearest"}),t.classList.add("wms_is_selected"))})}(r,function(e){var i={0:o("Lundi","wc-multishipping"),1:o("Mardi","wc-multishipping"),2:o("Mercredi","wc-multishipping"),3:o("Jeudi","wc-multishipping"),4:o("Vendredi","wc-multishipping"),5:o("Samedi","wc-multishipping"),6:o("Dimanche","wc-multishipping")},t='<table class="wms_pickup_open_time"><tbody>';e.opening_time.forEach(function(e,n){t+="<tr><td>".concat(i[n],"</td><td>").concat(e,"</td></tr>")}),t+="</tbody></table>";var r='\n      <div class="wms_pickup_modal_listing_one" data-pickup-name="'.concat(e.name,'">\n        <div class="wms_pickup_name">').concat(e.name,'</div>\n        <div class="wms_pickup_address1" data-pickup-address1="').concat(e.address,'">').concat(e.address,'</div>\n        <div class="wms_pickup_address2">\n          <span class="wms_pickup_zipcode" data-pickup-zipcode="').concat(e.zip_code,'">').concat(e.zip_code,'</span>\n          <span class="wms_pickup_city" data-pickup-city="').concat(e.city,'">').concat(e.city,'</span>\n        </div>\n        <div class="wms_pickup_country" data-pickup-country="').concat(e.country,'">').concat(e.country,"</div>\n        ").concat(t,'\n        <button class="button wms_pickup_modal_listing_one_button_ship" data-pickup-id="').concat(e.id,'">\n          ').concat(o("Envoyer à cette adresse","wc-multishipping"),"\n        </button>\n      </div>\n    ");return c.listingContainer.innerHTML+=r,new n.maps.InfoWindow({content:r.replace("wms_pickup_modal_listing_one_button_ship","wms_pickup_modal_infowindow_one_button_ship")})}(e)),c.markers.push(r),i.extend(t)}),c.map.fitBounds(i),document.querySelectorAll(".wms_pickup_modal_listing_one").forEach(function(e){e.addEventListener("click",function(){l(),this.classList.add("wms_is_selected")})}),s()}else a(o("Aucun point relais trouvé pour cette adresse","wc-multishipping"))}function m(){var e=function(){var e,i,n;if(!c.modal)return null;var t=(null===(e=c.modal.querySelector(".wms_pickup_modal_address_country_select select"))||void 0===e?void 0:e.value)||"FR",o=(null===(i=c.modal.querySelector(".wms_pickup_modal_address_zipcode_input"))||void 0===i?void 0:i.value)||"",r=(null===(n=c.modal.querySelector(".wms_pickup_modal_address_city_input"))||void 0===n?void 0:n.value)||"";return{country:t.trim(),zipcode:o.trim(),city:r.trim()}}();if(e){var n=function(e){var i=[];return e.zipcode&&""!==e.zipcode.trim()?e.zipcode.length<4&&i.push(o("Le code postal doit contenir au moins 4 caractères","wc-multishipping")):i.push(o("Le code postal est requis","wc-multishipping")),e.city&&""!==e.city.trim()||console.warn("WMS: City is empty, search might be less accurate"),e.country&&""!==e.country.trim()||i.push(o("Le pays est requis","wc-multishipping")),{isValid:0===i.length,errors:i}}(e);if(n.isValid){c.loader&&(c.loader.style.display="block");var t=i("#wms_shipping_provider").val(),r=i("#wms_nonce").val(),l={action:"wms_get_pickup_point",shipping_provider:t,shipping_method_id:function(){var e,i=null===(e=document.getElementsByClassName("wc-block-components-shipping-rates-control__package")[0])||void 0===e||null===(e=e.getElementsByClassName("wc-block-components-radio-control__option-checked")[0])||void 0===e||null===(e=e.firstChild)||void 0===e?void 0:e.value;if(i)return i;var n=document.querySelector('input[name^="shipping_method"]:checked');return n?n.value:null}(),country:e.country,zipcode:e.zipcode,city:e.city,wms_nonce:r};return i.get(WMS.ajaxurl,l).done(p).fail(u).always(d)}a(n.errors.join("<br>"))}else a(o("Impossible de récupérer l'adresse","wc-multishipping"))}function _(){var e,i=null===(e=c.modal)||void 0===e?void 0:e.querySelector(".wms_pickup_modal_address_search");i&&i.addEventListener("click",function(){c.markers.forEach(function(e){e.setMap(null)}),c.markers=[],m()})}function v(){var e,i,t,o,r,a={zoom:15,mapTypeId:n.maps.MapTypeId.ROADMAP,center:{lat:48.866667,lng:2.333333},disableDefaultUI:!0},d=null===(e=c.modal)||void 0===e?void 0:e.querySelector("#wms_pickup_modal_map_googlemaps");if(d){c.map=new n.maps.Map(d,a),c.listingContainer=null===(i=c.modal)||void 0===i?void 0:i.querySelector(".wms_pickup_modal_listing");var l=function(){var e,i,n=(null===(e=document.getElementById("ship-to-different-address-checkbox"))||void 0===e?void 0:e.checked)||!1,t={city:[{id:"shipping_city",condition:n},{id:"billing_city",condition:!0},{id:"shipping-city",condition:!0},{id:"billing-city",condition:!0}],zipcode:[{id:"shipping_postcode",condition:n},{id:"billing_postcode",condition:!0},{id:"shipping-postcode",condition:!0},{id:"billing-postcode",condition:!0}],country:[{id:"shipping_country",condition:n},{id:"billing_country",condition:!0},{id:"shipping-country",condition:!0},{id:"billing-country",condition:!0}]},o={city:"Paris",zipcode:"75001",country:"FR"},r=_createForOfIteratorHelper(t.city);try{for(r.s();!(i=r.n()).done;){var c=i.value;if(c.condition){var a=document.getElementById(c.id);if(null!=a&&a.value){o.city=a.value;break}}}}catch(e){r.e(e)}finally{r.f()}var d,l=_createForOfIteratorHelper(t.zipcode);try{for(l.s();!(d=l.n()).done;){var s=d.value;if(s.condition){var u=document.getElementById(s.id);if(null!=u&&u.value){o.zipcode=u.value;break}}}}catch(e){l.e(e)}finally{l.f()}var p,m=_createForOfIteratorHelper(t.country);try{for(m.s();!(p=m.n()).done;){var _=p.value;if(_.condition){var v=document.getElementById(_.id);if(v){var y=v.querySelector("input"),f=y?y.value:v.value;if(f){o.country=f;break}}}}}catch(e){m.e(e)}finally{m.f()}return o}(),s=null===(t=c.modal)||void 0===t?void 0:t.querySelector(".wms_pickup_modal_address_city_input"),u=null===(o=c.modal)||void 0===o?void 0:o.querySelector(".wms_pickup_modal_address_zipcode_input"),p=null===(r=c.modal)||void 0===r?void 0:r.querySelector(".wms_pickup_modal_address_country_select select");u&&l.zipcode&&"75001"!==l.zipcode&&(u.value=l.zipcode,s&&l.city&&"Paris"!==l.city&&(s.value=l.city)),p&&l.country&&(p.value=l.country),_(),m()}else console.error("WMS Google Maps: Map element not found")}function y(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"wms_pickup_open_modal_google_maps",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",t=document.querySelectorAll(".".concat(e));0!==t.length&&t.forEach(function(e){e.getAttribute("wms-backbone-set")||(e.addEventListener("click",function(e){e.preventDefault();var t=n.length>0?n:this.getAttribute("wms-pickup-modal-id");i(this).WCBackboneModal({template:t});var o,r=document.getElementById(t);r&&(o=r,c.modal=o,c.loader=null==o?void 0:o.querySelector(".wc-backbone-modal-loader"),v())}),e.setAttribute("wms-backbone-set","true"))})}function f(){y(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"wms_pickup_open_modal_google_maps",arguments.length>1&&void 0!==arguments[1]?arguments[1]:"")}}(window,jQuery,google,wp);