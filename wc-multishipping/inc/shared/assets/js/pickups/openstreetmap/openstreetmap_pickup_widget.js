"use strict";function _createForOfIteratorHelper(i,e){var t="undefined"!=typeof Symbol&&i[Symbol.iterator]||i["@@iterator"];if(!t){if(Array.isArray(i)||(t=_unsupportedIterableToArray(i))||e&&i&&"number"==typeof i.length){t&&(i=t);var n=0,o=function(){};return{s:o,n:function(){return n>=i.length?{done:!0}:{done:!1,value:i[n++]}},e:function(i){throw i},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,c=!0,a=!1;return{s:function(){t=t.call(i)},n:function(){var i=t.next();return c=i.done,i},e:function(i){a=!0,r=i},f:function(){try{c||null==t.return||t.return()}finally{if(a)throw r}}}}function _unsupportedIterableToArray(i,e){if(i){if("string"==typeof i)return _arrayLikeToArray(i,e);var t=Object.prototype.toString.call(i).slice(8,-1);return"Object"===t&&i.constructor&&(t=i.constructor.name),"Map"===t||"Set"===t?Array.from(i):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(i,e):void 0}}function _arrayLikeToArray(i,e){(null==e||e>i.length)&&(e=i.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=i[t];return n}!function(i,e,t,n){if(void 0!==e&&void 0!==t&&void 0!==n){var o=n.i18n.__,r=n.i18n.sprintf,c={modal:null,loader:null,markers:[],map:null,listingContainer:null,isInitialized:!1};e(function(){e(document.body).on("updated_shipping_method",function(){return y()}).on("updated_wc_div",function(){return y()}).on("updated_checkout",function(){return y()}),y()}),i.set_wms_openstreetmap_pickup_modal=y}else console.error("WMS OpenStreetMap: Missing dependencies");function a(){c.map&&(c.markers.forEach(function(i){try{c.map.removeLayer(i)}catch(i){console.warn("WMS: Error removing marker",i)}}),c.markers=[])}function s(i){c.listingContainer&&(c.listingContainer.innerHTML='\n      <div class="wms-error-message" style="color: #dc3232; padding: 15px; background: #fef7f7; border-left: 4px solid #dc3232; margin: 10px 0;">\n        <strong>'.concat(o("Erreur","wc-multishipping"),":</strong> ").concat(i,"\n      </div>\n    "))}function d(){c.loader&&(c.loader.style.display="none")}function u(){var i=function(){var i,e,t;if(!c.modal)return null;var n=(null===(i=c.modal.querySelector(".wms_pickup_modal_address_country_select select"))||void 0===i?void 0:i.value)||"FR",o=(null===(e=c.modal.querySelector(".wms_pickup_modal_address_zipcode_input"))||void 0===e?void 0:e.value)||"",r=(null===(t=c.modal.querySelector(".wms_pickup_modal_address_city_input"))||void 0===t?void 0:t.value)||"";return{country:n.trim(),zipcode:o.trim(),city:r.trim()}}();if(!i)return s(o("Impossible de récupérer l'adresse","wc-multishipping")),Promise.reject("No address");var t=function(i){var e=[];return i.zipcode&&""!==i.zipcode.trim()?i.zipcode.length<4&&e.push(o("Le code postal doit contenir au moins 4 caractères","wc-multishipping")):e.push(o("Le code postal est requis","wc-multishipping")),i.city&&""!==i.city.trim()||console.warn("WMS: City is empty, search might be less accurate"),i.country&&""!==i.country.trim()||e.push(o("Le pays est requis","wc-multishipping")),{isValid:0===e.length,errors:e}}(i);if(!t.isValid)return s(t.errors.join("<br>")),Promise.reject(t.errors);c.loader&&(c.loader.style.display="block"),a();var n=e("#wms_nonce").val(),r={action:"wms_get_pickup_point",shipping_provider:e("#wms_shipping_provider").val(),shipping_method_id:function(){var i,e=null===(i=document.getElementsByClassName("wc-block-components-shipping-rates-control__package")[0])||void 0===i||null===(i=i.getElementsByClassName("wc-block-components-radio-control__option-checked")[0])||void 0===i||null===(i=i.firstChild)||void 0===i?void 0:i.value;if(e)return e;var t=document.querySelector('input[name^="shipping_method"]:checked');return t?t.value:null}(),country:i.country,zipcode:i.zipcode,city:i.city,wms_nonce:n};return e.get(WMS.ajaxurl,r).done(p).fail(l).always(d)}function p(i){i.error?s(i.error_message||o("Une erreur est survenue","wc-multishipping")):i.data&&0!==i.data.length?(c.listingContainer=c.modal.querySelector(".wms_pickup_modal_listing"),c.listingContainer?(c.listingContainer.innerHTML="",i.data.forEach(function(i,e){!function(i,e){if(!c.map||!c.listingContainer)return;var n=parseFloat(i.latitude),r=parseFloat(i.longitude);if(isNaN(n)||isNaN(r))return void console.warn("WMS: Invalid coordinates for point",i);e&&c.map.setView([n,r],13);var a=t.marker([n,r],{title:i.name}).addTo(c.map),s=function(i){var e={0:o("Lundi","wc-multishipping"),1:o("Mardi","wc-multishipping"),2:o("Mercredi","wc-multishipping"),3:o("Jeudi","wc-multishipping"),4:o("Vendredi","wc-multishipping"),5:o("Samedi","wc-multishipping"),6:o("Dimanche","wc-multishipping")};if(!i.opening_time)return'<div class="wms-popup-content">\n        <div>'.concat(i.address,"</div>\n        <div>").concat(i.zip_code," ").concat(i.city,"</div>\n      </div>");var t='<table class="wms_pickup_open_time"><tbody>';return i.opening_time.forEach(function(i,n){t+="<tr><td>".concat(e[n],"</td><td>").concat(i,"</td></tr>")}),t+="</tbody></table>",'<div class="wms-popup-content">\n      <div>'.concat(i.address,"</div>\n      <div>").concat(i.zip_code," ").concat(i.city,"</div>\n      ").concat(t,'\n      <button class="button wms_pickup_modal_infowindow_one_button_ship" data-pickup-id="').concat(i.id,'">\n        ').concat(o("Envoyer à cette adresse","wc-multishipping"),"\n      </button>\n    </div>")}(i);a.bindPopup("<b>".concat(i.name,"</b><br>").concat(s)).on("click",function(){return function(i){m();var e=c.modal.querySelector('.wms_pickup_modal_listing [data-pickup-name="'.concat(i,'"]'));e&&(e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add("wms_is_selected"));setTimeout(function(){var i=document.querySelectorAll(".wms_pickup_modal_infowindow_one_button_ship");i.forEach(function(i){i.addEventListener("click",_)})},100)}(i.name)}),c.markers.push(a);var d=function(i){var e={0:o("Lundi","wc-multishipping"),1:o("Mardi","wc-multishipping"),2:o("Mercredi","wc-multishipping"),3:o("Jeudi","wc-multishipping"),4:o("Vendredi","wc-multishipping"),5:o("Samedi","wc-multishipping"),6:o("Dimanche","wc-multishipping")},t="";i.opening_time&&(t='<table class="wms_pickup_open_time"><tbody>',i.opening_time.forEach(function(i,n){t+="<tr><td>".concat(e[n],"</td><td>").concat(i,"</td></tr>")}),t+="</tbody></table>");return'<div class="wms_pickup_modal_listing_one" data-pickup-name="'.concat(i.name,'" data-pickup-id="').concat(i.id,'">\n      <div class="wms_pickup_name">').concat(i.name,'</div>\n      <div class="wms_pickup_address1" data-pickup-address1="').concat(i.address,'">').concat(i.address,'</div>\n      <div class="wms_pickup_address2">\n        <span class="wms_pickup_zipcode" data-pickup-zipcode="').concat(i.zip_code,'">').concat(i.zip_code,'</span>\n        <span class="wms_pickup_city" data-pickup-city="').concat(i.city,'">').concat(i.city,'</span>\n      </div>\n      <div class="wms_pickup_country" data-pickup-country="').concat(i.country,'">').concat(i.country,"</div>\n      ").concat(t,'\n      <button class="button wms_pickup_modal_listing_one_button_ship" data-pickup-id="').concat(i.id,'">\n        ').concat(o("Envoyer à cette adresse","wc-multishipping"),"\n      </button>\n    </div>")}(i);c.listingContainer.innerHTML+=d}(i,0===e)}),c.modal.querySelectorAll(".wms_pickup_modal_listing_one").forEach(function(i){i.addEventListener("click",function(){m(),this.classList.add("wms_is_selected")})}),c.modal.querySelectorAll(".wms_pickup_modal_listing_one_button_ship").forEach(function(i){i.addEventListener("click",_)})):console.error("WMS: Listing container not found")):s(o("Aucun point relais trouvé pour cette adresse","wc-multishipping"))}function l(i,e,t){var n;console.error("WMS AJAX Error:",{xhr:i,status:e,error:t});var r=o("Erreur de connexion au serveur","wc-multishipping");null!==(n=i.responseJSON)&&void 0!==n&&n.error_message?r=i.responseJSON.error_message:0===i.status?r=o("Pas de connexion internet","wc-multishipping"):404===i.status?r=o("Service non trouvé (404)","wc-multishipping"):500===i.status&&(r=o("Erreur serveur (500)","wc-multishipping")),s(r)}function m(){document.querySelectorAll(".wms_pickup_modal_listing_one").forEach(function(i){return i.classList.remove("wms_is_selected")})}function _(t){var n,a,s,d;t.stopPropagation();var u=t.currentTarget,p=u.getAttribute("data-pickup-id"),l=u.closest(".wms_pickup_modal_listing_one");if(!l&&p&&c.modal){var m=i.CSS&&"function"==typeof i.CSS.escape?i.CSS.escape(p):p;l=c.modal.querySelector('.wms_pickup_modal_listing_one[data-pickup-id="'.concat(m,'"]'))}if(l){var _={id:p,name:l.getAttribute("data-pickup-name"),address:(null===(n=l.querySelector(".wms_pickup_address1"))||void 0===n?void 0:n.getAttribute("data-pickup-address1"))||"",zipcode:(null===(a=l.querySelector(".wms_pickup_zipcode"))||void 0===a?void 0:a.getAttribute("data-pickup-zipcode"))||"",city:(null===(s=l.querySelector(".wms_pickup_city"))||void 0===s?void 0:s.getAttribute("data-pickup-city"))||"",country:(null===(d=l.querySelector(".wms_pickup_country"))||void 0===d?void 0:d.getAttribute("data-pickup-country"))||""},v=r(o("Merci de confirmer votre choix: %s","wc-multishipping"),"\n\n".concat(_.name,"\n").concat(_.address,"\n").concat(_.city," ").concat(_.zipcode,"\n").concat(_.country));confirm(v)&&function(i){var t=e("#wms_shipping_provider").val(),n=e("#wms_nonce").val(),r=e("#wms_ajax_error"),a=e("#wms_pickup_selected");e.ajax({url:WMS.ajaxurl,type:"POST",dataType:"json",data:{action:"wms_select_pickup_point",pickup_id:i.id,pickup_name:i.name,pickup_address:i.address,pickup_zipcode:i.zipcode,pickup_city:i.city,pickup_country:i.country,pickup_provider:t,wms_nonce:n},beforeSend:function(){r.hide()},success:function(t){if(!1===t.error){var n;e("#wms_pickup_point").val(i.id).trigger("change");var s=[i.name,i.address,"".concat(i.city," ").concat(i.zipcode),i.country];a.html("<div>"+s.join("</div><div>")+"</div>"),e("#wms_pickup_info").val(JSON.stringify(s)),null===(n=c.modal.querySelector(".modal-close"))||void 0===n||n.click(),e(".wc-block-components-shipping-address").each(function(){-1!==e(this).html().indexOf("Livraison à")&&e(this).html("Livraison à : "+s.join("\n"))}),e("body").trigger("update_checkout")}else r.html(t.error_message||o("Erreur lors de la sauvegarde","wc-multishipping")),r.show()},error:function(i,e,t){console.error("WMS: Save error",{xhr:i,status:e,error:t}),r.html(o("Erreur de connexion","wc-multishipping")),r.show()}})}(_)}else console.error("WMS: Could not find pickup element",{pickupId:p,buttonClass:u&&u.className})}function v(){if(!c.modal)return console.error("WMS: Modal not found"),!1;if(c.loader=c.modal.querySelector(".wc-backbone-modal-loader"),c.listingContainer=c.modal.querySelector(".wms_pickup_modal_listing"),!function(){var i=document.getElementById("wms_pickup_modal_map_openstreemap");if(!i)return console.error("WMS: Map container not found"),!1;if(c.map)try{c.map.remove(),c.map=null}catch(i){console.warn("WMS: Error removing existing map",i)}i.innerHTML="";try{return c.map=t.map(i).setView([48.866667,2.333333],14),t.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',minZoom:1,maxZoom:20}).addTo(c.map),!0}catch(i){return console.error("WMS: Error initializing map",i),!1}}())return!1;var i=function(){var i,e,t=(null===(i=document.getElementById("ship-to-different-address-checkbox"))||void 0===i?void 0:i.checked)||!1,n={city:[{id:"shipping_city",condition:t},{id:"billing_city",condition:!0},{id:"shipping-city",condition:!0},{id:"billing-city",condition:!0}],zipcode:[{id:"shipping_postcode",condition:t},{id:"billing_postcode",condition:!0},{id:"shipping-postcode",condition:!0},{id:"billing-postcode",condition:!0}],country:[{id:"shipping_country",condition:t},{id:"billing_country",condition:!0},{id:"shipping-country",condition:!0},{id:"billing-country",condition:!0}]},o={city:"Paris",zipcode:"75001",country:"FR"},r=_createForOfIteratorHelper(n.city);try{for(r.s();!(e=r.n()).done;){var c=e.value;if(c.condition){var a=document.getElementById(c.id);if(null!=a&&a.value){o.city=a.value;break}}}}catch(i){r.e(i)}finally{r.f()}var s,d=_createForOfIteratorHelper(n.zipcode);try{for(d.s();!(s=d.n()).done;){var u=s.value;if(u.condition){var p=document.getElementById(u.id);if(null!=p&&p.value){o.zipcode=p.value;break}}}}catch(i){d.e(i)}finally{d.f()}var l,m=_createForOfIteratorHelper(n.country);try{for(m.s();!(l=m.n()).done;){var _=l.value;if(_.condition){var v=document.getElementById(_.id);if(v){var y=v.querySelector("input");if(o.country=(null==y?void 0:y.value)||v.value||o.country,"FR"!==o.country)break}}}}catch(i){m.e(i)}finally{m.f()}return o}(),e=c.modal.querySelector(".wms_pickup_modal_address_city_input"),n=c.modal.querySelector(".wms_pickup_modal_address_zipcode_input"),o=c.modal.querySelector(".wms_pickup_modal_address_country_select select");n&&i.zipcode&&"75001"!==i.zipcode&&(n.value=i.zipcode,e&&i.city&&"Paris"!==i.city&&(e.value=i.city)),o&&(o.value=i.country);var r=c.modal.querySelector(".wms_pickup_modal_address_search");return r&&r.addEventListener("click",function(){a(),u()}),u(),c.isInitialized=!0,!0}function y(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"wms_pickup_open_modal_openstreetmap",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=document.getElementsByClassName(i);0!==n.length&&Array.from(n).forEach(function(i){!function(i,t){i.getAttribute("wms-backbone-set")||(i.addEventListener("click",function(i){i.preventDefault(),e(this).WCBackboneModal({template:t||this.getAttribute("wms-pickup-modal-id")}),c.modal=document.getElementById(t||this.getAttribute("wms-pickup-modal-id")),c.modal&&v()}),i.setAttribute("wms-backbone-set","true"))}(i,t)})}}(window,jQuery,L,wp);